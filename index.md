## 索引原理

### 哈希
1. 只适用于等值查询
2. 在有大量重复键的情况下，效率不高

### 二叉搜索树
1. 当数据量大的时候，树的高度会比较高，查询会比较慢
2. 每个节点只存储一个记录，可能导致一次查询有很多次磁盘 IO

### B 树
1. 不再是二叉搜索，而是 m 叉搜索，高度能够大大降低
2. 叶子节点与非叶子节点，都存储数据
3. 通过中序遍历，可以获得所有节点

### B+ 树
1. 非叶子节点不再存储数据，数据只存储在同一层的叶子节点上。因此非叶子节点只存储 key，同样大小的磁盘页能比 B 树存储更多索引
2. 叶子之间，增加了链表，可以通过遍历获取所有节点，不再需要中序遍历；范围查找，定位 min 与 max 之后，中间叶子节点，就是结果集
3. 叶子节点存储实际记录行，记录行相对比较紧密的存储，适合大数据量磁盘存储；非叶子节点存储记录的PK，用于查询加速，适合内存存储

## 索引实现

### `MyISAM`
1. 主键索引与普通索引没有本质差异
2. 只有非聚集索引，即索引与数据是分开存储的
3. 主键索引的叶子节点，存储主键与对应行记录的指针；普通索引的叶子结点，存储索引列与对应行记录的指针

### `InnoDb`
1. 每一个表都会有聚集索引，且只能有一个
  1.1 如果表定义了主键，则主键就是聚集索引
  1.2 如果表没有定义主键，则第一个非空 `unique` 列是聚集索引
  1.3 如果以上条件都不满足，则会创建一个隐藏的 `row id` 作为聚集索引

2. 主键索引的叶子节点会存储主键与数据行，即数据与索引在一起；非主键索引（二级索引）只会存储主键值，因此基于非主键索引的查询需要先扫描非主键索引树以找到对应主键键值，然后再扫描主键索引树

3. 不建议使用类似字符串这种较长的列做主键，因为所有的普通索引都会存储主键，过长的主键会导致普通索引过于庞大

4. 建议使用趋势递增的列作为主键，因为数据行与主键索引存在一起，这样不至于插入记录时引起大量索引分裂、记录行移动

## 索引回表
```sql
select * from user where age between 15 and 20;
```
以上查询会经历一下步骤：
1. 在 age 索引树上找到 age = 15 的记录，取得 id
2. 根据 id 查询 id 索引树，获取行数据
3. 再在 age 索引树上面取下一个值 age = 16 的记录，获取 id
4. 根据 id 查询 id 索引树，获取行数据
5. 重复上述操作，直至 age 不符合条件

在以上过程中，回到主键索引树搜索的过程，我们称为回表。这是因为查询结果所需的数据只有主键索引上有，所以不得不回表。但如果执行语句是这样的：
```sql
select id from user where age between 15 and 20;
```
那么这时只需要查 id 的值，而 id 的值已经在 age 索引树上，因此可以直接提供查询结果，不需要回表。此时称 age 索引为覆盖索引。在数据库索引建立过程中，可以通过建立冗余索引来支持覆盖索引，达到优化查询的目的

### 索引下推
```sql
select * from user where name like '张 %' and age=10 and ismale=1;
```
假设已有联合索引 (name, age)，则该语句在搜索索引树的时候，只能用 `name` 索引，根据 `name` 索引找到第一个满足条件的记录后，然后从找到的第一个满足条件的记录开始一个个回表。到主键索引上找出数据行，再对 `age`、`ismale` 字段值。

MySQL 5.6 引入的索引下推优化（index condition pushdown)，可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数

### 索引组合
索引 (age, name) + (name) 相比于 (name, age) + (age) 效果一样，但所需空间较多

## 重建索引
### 重建普通索引
```sql
alter table user drop index k;
alter table user add index(k);
```

### 重建主键索引
以下重建索引的方式是错误的。这是因为普通索引中存储的是主键的键值，如果删除主键索引，会导致普通索引都会失效，并且使用 `row id` 来做主键索引。因此以下重建主键索引的方式会导致普通索引也会重新构造，性能开销比较大
```sql
alter table user drop primary key;
alter table user add primary key(id);
```
正确的重建索引方式是这样的：
```sql
alter table user engine=InnoDB;
```

