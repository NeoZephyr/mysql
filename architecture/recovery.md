## 表空间
InnoDB 存储引擎的文件格式是 .ibd 文件，数据会按照表空间进行存储，分为共享表空间和独立表空间

如果采用共享表空间的模式，表数据都会放到共享表空间中，同时表空间也会自动分成多个文件存放到磁盘上。这样做的好处在于单个数据表的大小可以突破文件系统大小的限制，最大可以达到 64TB。不足也很明显，多个数据表存放到一起，结构不清晰，不利于数据的找回，同时将所有数据和索引都存放到一个文件中，也会使得共享表空间的文件很大

采用独立表空间的方式可以让每个数据表都有自己的物理文件，在这个文件中保存了数据表中的数据、索引、表的内部数据字典等信息。它的优势在于每张表都相互独立，不会影响到其他数据表，存储结构清晰，利于数据恢复，同时数据表还可以在不同的数据库之间进行迁移


## idb 恢复
在保存数据行的时候有个删除标记位，对应的是页结构中的 delete_mask 属性，该属性为 1 的时候标记了记录已经被逻辑删除，实际上并不是真的删除。不过当有新的记录插入的时候，被删除的行记录可能会被覆盖掉。所以当发生误删除的时候，一定要第一时间停止对误删除的表进行更新和写入，及时将 .ibd 文件拷贝出来并进行修复

如果发生了意外，InnoDB 可以在读取数据表时自动修复错误。但有时候 .ibd 文件损坏了，会导致数据库无法正常读取数据表，这时需要人工介入
```sql
show variables like 'innodb_force_recovery';
```
innodb_force_recovery 参数一共有 7 种状态。默认为 0，表示不进行强制恢复。此外还可以为 1-6 的取值，分别代表不同的强制恢复措施

当需要强制恢复时，可以将 innodb_force_recovery 设置为 1，表示即使发现了损坏页也可以继续让服务运行，这样就可以读取数据表，并且对当前损坏的数据表进行分析和备份。通常 innodb_force_recovery 参数设置为 1，只要能正常读取数据表即可。但如果参数设置为 1 之后还无法读取数据表，我们可以将参数逐一增加。一般来说不需要将参数设置到 4 或以上，因为这有可能对数据文件造成永久破坏

另外当 innodb_force_recovery 设置为大于 0 时，只能进行有限制读取操作，对于 WHERE 条件以及 ORDER BY 都无法进行操作。当开启了强制恢复之后，数据库的功能会受到很多限制，需要尽快把有问题的数据表备份出来，完成数据恢复操作。整体的恢复步骤可以按照如下：
1. 将 innodb_force_recovery 参数设置为 1，启动数据库。如果数据表不能正常读取，调大参数直到能读取数据为止
2. 由于 InnoDB 存储引擎已经写保护了，使用 MyISAM 存储引擎准备一个新的数据表，将损坏的 InnoDB 数据表备份到新的 MyISAM 数据表中
3. 数据备份完成之后，可以删除掉原有损坏的 InnoDB 数据表，然后将新表进行改名
4. 关闭 innodb_force_recovery，重启数据库，并且将数据表的 MyISAM 存储引擎更新为 InnoDB 存储引擎

